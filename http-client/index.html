<!doctype html>
<html lang="en">
<head>
  <title>Avaje</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="shortcut icon" href="/images/favicon.ico">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Source+Sans+Pro|Ubuntu&display=swap">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.1.0/css/all.css" integrity="sha384-lKuwvrZot6UHsBSfcMvOkWwlCMgc0TaWr+30HWe3a4ltaBwTZhyTEggF5tJv8tbt" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/reset.css">
  <link rel="stylesheet" href="/css/site.css">
  <link rel="stylesheet" href="/css/pygments.css">
</head>
<body>

<div class="container">
  <aside id="sidenav">
    <nav class="side scroll">
<ul>
  <li><a href="#overview">Overview</a>
</li>
<li><a href="#dependencies">Dependencies</a>
</li>
<li><a href="#limitations">Limitations</a>
</li>
<li><a href="#jdk-intro">HttpClient Intro</a>
</li>
<li><a href="#quick-overview">Quick overview</a>
</li>
<li><a href="#sync-async">Sync and Async</a>
</li>
<li><a href="#httpClientContext">HttpClientContext</a>
</li>
<li><a href="#request-body">Request body</a>
    <ul>
      <li><a href="#req-json">object JSON</a></li>
      <li><a href="#req-formparam">formParam</a></li>
      <li><a href="#req-path">path (file)</a></li>
      <li><a href="#req-inputStream">inputStream</a></li>
      <li><a href="#req-bodyPublisher">bodyPublisher</a></li>
    </ul>
</li>
<li><a href="#response-body">Response body</a>
    <ul>
      <li><a href="#bean">bean</a></li>
      <li><a href="#list">list</a></li>
      <li><a href="#stream">stream</a></li>
      <li><a href="#asVoid">void</a></li>
      <li><a href="#asDiscarding">discarding</a></li>
      <li><a href="#asString">string</a></li>
      <li><a href="#withHandler">withHandler</a></li>
    </ul>
</li>
<li><a href="#httpException">HttpException</a>
</li>
<li><a href="#async">Async</a>
</li>
<li><a href="#httpCall">HttpCall</a>
</li>
<li><a href="#auth">Authorisation</a>
    <ul>
      <li><a href="#auth-basic">basic auth</a></li>
      <li><a href="#auth-bearer">bearer token</a></li>
    </ul>
</li>
<li><a href="#10k">10k requests & Loom</a>
    <ul>
      <li><a href="#10k-async">async</a></li>
      <li><a href="#10k-loom">loom</a></li>
    </ul
</li>
</ul>
<p>&nbsp;</p>
    </nav>
  </aside>
  <article id="main-content">
    
<h1 id="overview">avaje http client</h1>

<table width="100%">
  <tr>
    <th>License</th>
    <th>Source</th>
    <th>API Docs</th>
    <th>Issues</th>
    <th>Releases</th>
  </tr>
  <tr>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http-client/blob/master/LICENSE">Apache2</a></td>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http-client">Github</a></td>
    <td><a target="_blank" href="/apidocs/avaje-http-client">Javadoc</a></td>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http-client/issues">Github</a></td>
    <td><a target="_blank" href="https://github.com/avaje/avaje-http-client/releases">Latest 1.8</a></td>
  </tr>
</table>
<p>&nbsp;</p>

<h3>Wrap JDK HttpClient</h3>
<p>
  A lightweight wrapper to the <a target="_blank" href="http://openjdk.java.net/groups/net/httpclient/intro.html">JDK 11+ Java Http Client</a>.
</p>
<ul>
  <li>Requires Java 11+ (recommend 11.0.8+)</li>
  <li>Adds a fluid API for building URL and payload</li>
  <li>Adds JSON marshalling/unmarshalling of request and response using Jackson or Gson</li>
  <li>Gzip encoding/decoding</li>
  <li>Logging of request/response logging</li>
  <li>Interception of request/response</li>
  <li>Built in support for authorization via Basic Auth and Bearer Token</li>
  <li>Provides async and sync API</li>
</ul>

<h3>Client API generation</h3>
<p>
  Optionally we can define a java interface with annotations and have a Java
  annotation processor generate the client implementation (similar to Retrofit,
  Feign and JAX-RS client).
</p>
<ul>
  <li>Generates the implementation as source code via annotation processing</li>
  <li>Targets <em>avaje-http-client / JDK HttpClient</em> only</li>
</ul>
<p>
  This is similar to <a target="_blank" href="https://github.com/square/retrofit">Retrofit</a>,
  <a target="_blank" href="https://github.com/OpenFeign/feign">Feign</a> and JAX-RS client for people familiar with
  those projects. This client API generation targets <em>avaje-http-client / JDK HttpClient</em> only
  and uses source code generation via annotation processing.
</p>

<h5>Example client API</h5>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">interface</span> <span class="nc">GitHub</span> <span class="o">{</span>

  <span class="nd">@Get</span><span class="o">(</span><span class="s">&quot;/repos/{owner}/{repo}/contributors&quot;</span><span class="o">)</span>
  <span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="nf">contributors</span><span class="o">(</span><span class="n">String</span> <span class="n">owner</span><span class="o">,</span> <span class="n">String</span> <span class="n">repo</span><span class="o">);</span>

<span class="o">}</span>
</pre></div>
</div>



<h2 id="dependencies">Dependencies</h2>

<h3 id="maven">Maven</h3>
<p>
  Add <em>avaje-http-client</em> as a dependency.
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-http-client<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.8<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>Client API generation</h4>
<p>
  For the client API generation we need to add <em>avaje-http-api</em> as a dependency.
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-http-api<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.8<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<h4>Client API - Annotation processor</h4>
<p>
  Add the <em>avaje-http-client-generator</em> annotation processor.
  We can add it as a <em>provided</em> scope dependency or ...
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="c">&lt;!-- Annotation processors --&gt;</span>
<span class="nt">&lt;dependency&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>avaje-http-client-generator<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;version&gt;</span>1.8<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;scope&gt;</span>provided<span class="nt">&lt;/scope&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>
</div>

<p>
  If there are other annotation processors and they are specified via
  <em>maven-compiler-plugin</em> <em>annotationProcessorPaths</em>
  then we add <em>avaje-http-client-generator</em> there instead.
</p>
<div class="syntax xml"><div class="highlight"><pre><span></span><span class="nt">&lt;plugin&gt;</span>
  <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
  <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
  <span class="nt">&lt;configuration&gt;</span>
    <span class="nt">&lt;annotationProcessorPaths&gt;</span> <span class="c">&lt;!-- All annotation processors specified here --&gt;</span>
      <span class="nt">&lt;path&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>io.avaje<span class="nt">&lt;/groupId&gt;</span>
        <span class="nt">&lt;artifactId&gt;</span>avaje-http-client-generator<span class="nt">&lt;/artifactId&gt;</span>
        <span class="nt">&lt;version&gt;</span>1.8<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;/path&gt;</span>
      <span class="nt">&lt;path&gt;</span>
          ... other annotation processor ...
      <span class="nt">&lt;/path&gt;</span>
    <span class="nt">&lt;/annotationProcessorPaths&gt;</span>
  <span class="nt">&lt;/configuration&gt;</span>
<span class="nt">&lt;/plugin&gt;</span>
</pre></div>
</div>

<h3 id="gradle">Gradle</h3>
<p>
  See <a href="gradle">Gradle</a> for adding the dependencies using Gradle.
</p>



<h3 id="limitations">Limitations</h3>
<p>
  Current notable limitations are:
</p>
<ul>
  <li>No support for multipart-form body</li>
  <li>Retry (when specified) does not currently apply to <em>async</em> request processing</li>
</ul>


<h3 id="jdk-intro">JDK HttpClient Introduction</h3>
<p>
  Some introductions to the JDK HttpClient:
</p>
<ul>
  <li>JDK HttpClient <a target="_blank" href="http://openjdk.java.net/groups/net/httpclient/intro.html">Introduction</a></li>
  <li>Javadoc for <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpClient.html">JDK HttpClient</a> </li>
  <li>A closer look at the <a target="_blank" href="https://golb.hplar.ch/2019/01/java-11-http-client.html">Java 11 HTTP Client</a></li>
</ul>


<h3 id="quick-overview">Quick overview</h3>

<h4>HttpClientContext</h4>
<p>
  Create a HttpClientContext with a base URL plus options for request logging,
  JSON marshalling via Jackson or Gson, retry etc.
</p>
<p>
  Use the HttpClientContext to create requests. Requests can be executed synchronously or asynchronously with
  CompletableFuture.
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">public</span> <span class="n">HttpClientContext</span> <span class="nf">client</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">HttpClientContext</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withBaseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withRequestListener</span><span class="o">(</span><span class="k">new</span> <span class="n">RequestLogger</span><span class="o">())</span>
    <span class="o">.</span><span class="na">withBodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JacksonBodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">()))</span>
    <span class="c1">//.withBodyAdapter(new GsonBodyAdapter(new Gson()))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>
</div>

<h4>Example GET</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">httpClientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h4>Example GET Async</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">httpClientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">asString</span><span class="o">()</span>  <span class="c1">// CompletableFuture&lt;HttpResponse&lt;String&gt;&gt;</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">// CompletionException</span>
     <span class="o">...</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="c1">// HttpResponse&lt;String&gt;</span>
     <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
</div>


<h2 id="sync-async">Sync and Async</h2>
<p>
  We can make requests in simple blocking manor or via <code>async()</code>
  in an asynchronous style using <code>CompletableFuture</code>.
</p>
<p>
  JDK HttpClient provides a number of <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandler.html">BodyHandlers</a>
  including reactive Flow based subscribers. When executing the requests in
  asynchronous style the responses are processed in a reactive way. Generally
  <code>CompletableFuture.whenComplete()</code> will be called only when the
  response is ready.
</p>
<p>
  Using <a href="#withHandler">withHandler(...)</a> we can use any of these or our own
  <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandler.html">HttpResponse.BodyHandler</a>
  implementation.
</p>

<h3>Loom vs Async</h3>
<p>
  With Loom we can use simple blocking requests and get the same non-blocking
  behaviour as the <code>async()</code> requests.
</p>
<p>
  See <a href="#10k">10K requests - Loom vs Async</a>
</p>

<h2 id="httpClientContext">HttpClientContext</h2>
<p>
  HttpClientContext is effectively a wrapper of <a href="">java.net.http.HttpClient</a>
  with extra features for request interceptors, body adapters, retry.
</p>
<p>
  Create a HttpClientContext with a base URL plus options for request logging,
  JSON marshalling via Jackson or Gson, retry etc.
</p>
<p>
  From HttpClientContext we create requests and execute them.
</p>

<h4>Example creating HttpClientContext</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClientContext</span> <span class="n">httpClientContext</span> <span class="o">=</span>
  <span class="n">HttpClientContext</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">withBaseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
    <span class="o">.</span><span class="na">withRequestListener</span><span class="o">(</span><span class="k">new</span> <span class="n">RequestLogger</span><span class="o">())</span>
    <span class="o">.</span><span class="na">withBodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">JacksonBodyAdapter</span><span class="o">(</span><span class="k">new</span> <span class="n">ObjectMapper</span><span class="o">()))</span>
    <span class="c1">// .withBodyAdapter(new GsonBodyAdapter(new Gson()))</span>
    <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>
<p>
  Reference <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpClientContext.Builder.html">HttpClientContext.Builder</a>
</p>


<h2 id="request-body">Request body</h2>
<p>
  <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublisher.html">java.net.http.HttpRequest.BodyPublisher</a>
  is used for request body content.
  JDK HttpClient comes with a number of implementations which are great and we use. In
  addition we can use our own implementations.
</p>
<p>
  <em>avaje-http-client</em> adds URL encoded form and body adapters using Jackson and Gson
  to convert body content to/from JSON and java beans/types.
</p>

<h5>Request body</h5>
<ul>
  <li>Object which is written as JSON content by default</li>
  <li>formParam() for url encoded form</li>
  <li>byte[], String, Path (file), InputStream</li>
  <li>Any <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublishers.html">HttpRequest.BodyPublisher</a></li>
</ul>

<h3 id="req-json">Object as JSON</h3>
<p>
  When we create the HttpClientContext we register a message body handler.
  There is a supplied <code>JacksonBodyAdapter</code> and <code>GsonBodyAdapter</code>.
  When these are registered then when we call <code>body(object)</code> passing
  an Object this uses that body adapter to write the body content as JSON.
</p>

<h4>Example: POST object as json</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Hello</span> <span class="n">bean</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Hello</span><span class="o">(</span><span class="mi">42</span><span class="o">,</span> <span class="s">&quot;rob&quot;</span><span class="o">,</span> <span class="s">&quot;hello world&quot;</span><span class="o">);</span>

<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">bean</span><span class="o">)</span>
  <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asDiscarding</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-formParam">formParam</h3>
<p>
  Calling <code>formParam()</code> adds URL encoded name value pairs
  building request body content as <code>application/x-www-form-urlencoded</code>.
</p>

<h4>Example: POST using formParams</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;register/user&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="s">&quot;Bazz&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;email&quot;</span><span class="o">,</span> <span class="s">&quot;user@foo.com&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;url&quot;</span><span class="o">,</span> <span class="s">&quot;http://foo.com&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">formParam</span><span class="o">(</span><span class="s">&quot;startDate&quot;</span><span class="o">,</span> <span class="s">&quot;2020-12-03&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-path">Path (file)</h3>
<p>
  This uses <code>HttpRequest.BodyPublishers.ofFile(file)</code> to
  stream file content as the request body.
</p>

<h4>Example: PUT file Path</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Path</span> <span class="n">file</span> <span class="o">=</span> <span class="o">...;</span>
<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;upload&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">file</span><span class="o">)</span>
  <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-inputStream">InputStream</h3>
<p>
  This uses <code>HttpRequest.BodyPublishers.ofInputStream(supplier)</code>
  to stream the request body content from the InputStream.
</p>

<h4>Example: PUT InputStream</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Supplier</span><span class="o">&lt;</span><span class="n">InputStream</span><span class="o">&gt;</span> <span class="n">supplier</span> <span class="o">=</span> <span class="o">...;</span>

<span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;upload&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">supplier</span><span class="o">)</span>
  <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="req-bodyPublisher">HttpRequest.BodyPublisher</h3>
<p>
  We can pass any <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublisher.html">HttpRequest.BodyPublisher</a>
  into <code>body()</code>. Refer to <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpRequest.BodyPublishers.html">HttpRequest.BodyPublishers</a>
  for ones that come with JDK HttpClient.
</p>

<h4>Example: Use any BodyPublisher</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">res</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;whazzzup&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">HttpRequest</span><span class="o">.</span><span class="na field">BodyPublishers</span><span class="o">.</span><span class="na">ofString</span><span class="o">(</span><span class="s">&quot;silly example&quot;</span><span class="o">))</span>
  <span class="o">.</span><span class="na">PUT</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h2 id="response-body">Response body</h2>
<p>
  <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandler.html">java.net.http.HttpResponse.BodyHandler</a>
  is the interface used to handle response bodies. JDK HttpClient provides a number of
  <a target="_blank" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.net.http/java/net/http/HttpResponse.BodyHandlers.html">HttpResponse.BodyHandlers</a>
  including reactive Flow based subscribers.
</p>
<p>
  <em>avaje-http-client</em> has API to use the common ones such as String, Void, byte[] etc
  and we use <code>withHandler()</code> to use any BodyHandler implementation.
</p>

<h4>Summary of BodyHandlers</h4>
<table style="width:100%;">
  <tr><td>discarding()</td><td>Discards the response body</td></tr>
  <tr><td>ofByteArray()</td><td>byte[]</td></tr>
  <tr><td>ofString()</td><td>String, additional charset option</td></tr>
  <tr><td>ofLines()</td><td>Stream&lt;String&gt;</td></tr>
  <tr><td>ofInputStream()</td><td>InputStream</td></tr>
  <tr><td>ofFile(Path file)</td><td>Path with various options</td></tr>
  <tr><td>ofByteArrayConsumer(...)</td><td>&nbsp;</td></tr>
  <tr><td>fromSubscriber(...)</td><td>various options</td></tr>
  <tr><td>fromLineSubscriber(...)</td><td>various options</td></tr>
</table>

<h3 id="bean">bean(Class&lt;T&gt;)</h3>
<p>
  Return the response via body adapter as a java bean/type (typically JSON).
</p>
<p>
  If the HTTP status code is in the error range this throws a <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Customer</span> <span class="n">customer</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers/42&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="list">list(Class&lt;T&gt;)</h3>
<p>
  Return the response via body adapter as a list of java beans/type (typically JSON).
</p>
<p>
  If the HTTP status code is in the error range this throws a <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">List</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">list</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h3 id="stream">stream(Class&lt;T&gt;)</h3>
<p>
  Return the response via body adapter as a stream of java beans/type.
  The response is expected to be <code>application/x-json-stream</code>.
  Internally this uses <code>HttpResponse.BodyHandlers.asLines()</code> to
  get a stream of lines <code>Stream&lt;String&gt;</code>.
</p>
<p>
  If the HTTP status code is in the error range this throws a <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">Stream</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>


<h3 id="asVoid">asVoid()</h3>
<p>
  Return the as <code>HttpResponse&lt;Void&gt;</code> but the response
  content is still available to be read in the case of error response.
</p>
<p>
  If the HTTP status code is in the error range this throws a <a href="#httpException">HttpException</a>.
  From the HttpException we can get the underlying HttpResponse and error
  response body.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asVoid</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="asDiscarding">asDiscarding()</h3>
<p>
  Return the as <code>HttpResponse&lt;Void&gt;</code> but the response
  content is always discarded. Unlike <code>asVoid()</code> if there is an error
  response with content error content that content will not be available.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asDiscarding</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="asString">asString()</h3>
<p>
  Return the as <code>HttpResponse&lt;String&gt;</code>.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="withHandler">withHandler()</h3>
<p>
  Using <code>withHandler()</code> we can use any BodyHandler to process the response.
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">InputStream</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello/stream&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">withHandler</span><span class="o">(</span><span class="n">BodyHandlers</span><span class="o">.</span><span class="na">ofInputStream</span><span class="o">());</span>
</pre></div>
</div>



<h2 id="httpException">HttpException</h2>
<p>
  HttpException is thrown when the status code is >= 300 and the call is one of <a href="#bean">bean</a>,
  <a href="#list">list</a>, <a href="#stream">stream</a>, <a href="#asVoid">void</a>. Note that by default
  redirects are automatically followed by HttpClient apart for HTTPS to HTTP so 300 range responses are
  hence not expected and considered an error.
</p>
<p>
  Reference API javadoc <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpException.html">HttpException</a>
</p>
<p>
  HttpException effectively wraps the HttpResponse and provides helper methods to get the response body
  as String, byte[] or bean (via body adapter typically based on Jackson or Gson).
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>

<span class="c1">// the underlying HttpResponse</span>
<span class="n">HttpResponse</span><span class="o">&lt;?&gt;</span> <span class="n">httpResponse</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">httpResponse</span><span class="o">()</span>
<span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">httpResponse</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>

<span class="c1">// helper methods to read the response body</span>
<span class="n">String</span> <span class="n">errorBodyString</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bodyAsString</span><span class="o">();</span>
<span class="kt">byte</span><span class="o">[]</span> <span class="n">errorBodyBytes</span>  <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bodyAsBytes</span><span class="o">();</span>

<span class="c1">// helper method to read the response body as a bean (typically using Jackson/Gson)</span>
<span class="n">MyErrorBean</span> <span class="n">errorResponse</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">MyErrorBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</pre></div>
</div>

<h2 id="async">Async</h2>
<p>
  All requests can be made using <code>async</code> returning <code>CompletableFuture</code>.
  Commonly the <code>whenComplete()</code> callback will be used to process the async responses.
</p>
<p>
  The <em>bean()</em>, <em>list()</em> and <em>stream()</em> responses throw a
  <code><a href="#httpException">HttpException</a></code> if the status code >= 300 (noting that by default
  redirects are followed apart for HTTPS to HTTP).
</p>
<p>
  Reference API javadoc <a href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpAsyncResponse.html">HttpAsyncResponse</a>
</p>

<h4>Example: async().asString()</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello/world&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">asString</span><span class="o">()</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>
     <span class="n">String</span> <span class="n">body</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">body</span><span class="o">();</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
</div>

<h4>Example: async().bean(Class&lt;T&gt;)</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customer&quot;</span><span class="o">).</span><span class="na">path</span><span class="o">(</span><span class="mi">42</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
 <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">bean</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">customer</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>

   <span class="k">if</span> <span class="o">(</span><span class="n">throwable</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">HttpException</span> <span class="n">httpException</span> <span class="o">=</span> <span class="o">(</span><span class="n">HttpException</span><span class="o">)</span> <span class="n">throwable</span><span class="o">.</span><span class="na">getCause</span><span class="o">();</span>
     <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">getStatusCode</span><span class="o">();</span>

     <span class="c1">// maybe convert json error response body to a bean (using Jackson/Gson)</span>
     <span class="n">MyErrorBean</span> <span class="n">errorResponse</span> <span class="o">=</span> <span class="n">httpException</span><span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">MyErrorBean</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
     <span class="o">..</span>

   <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
     <span class="c1">// use customer</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">});</span>
</pre></div>
</div>

<h4>Example: async().withHandler()</h4>
<p>
  The example below is a line subscriber processing response content line by line.
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
 <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;hello/lineStream&quot;</span><span class="o">)</span>
 <span class="o">.</span><span class="na">GET</span><span class="o">().</span><span class="na">async</span><span class="o">()</span>
 <span class="o">.</span><span class="na">withHandler</span><span class="o">(</span><span class="n">HttpResponse</span><span class="o">.</span><span class="na field">BodyHandlers</span><span class="o">.</span><span class="na">fromLineSubscriber</span><span class="o">(</span><span class="k">new</span> <span class="n">Flow</span><span class="o">.</span><span class="na">Subscriber</span><span class="o">&lt;&gt;()</span> <span class="o">{</span>

   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onSubscribe</span><span class="o">(</span><span class="n">Flow</span><span class="o">.</span><span class="na">Subscription</span> <span class="n">subscription</span><span class="o">)</span> <span class="o">{</span>
     <span class="n">subscription</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onNext</span><span class="o">(</span><span class="n">String</span> <span class="n">item</span><span class="o">)</span> <span class="o">{</span>
     <span class="c1">// process the line of response content</span>
     <span class="o">...</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onError</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">{</span>
     <span class="o">...</span>
   <span class="o">}</span>
   <span class="nd">@Override</span>
   <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onComplete</span><span class="o">()</span> <span class="o">{</span>
     <span class="o">...</span>
   <span class="o">}</span>
 <span class="o">}))</span>
 <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
   <span class="kt">int</span> <span class="n">statusCode</span> <span class="o">=</span> <span class="n">hres</span><span class="o">.</span><span class="na">statusCode</span><span class="o">();</span>
   <span class="o">...</span>
 <span class="o">});</span>
</pre></div>
</div>

<h2 id="httpCall">HttpCall</h2>
<p>
  If we are creating an API and want the client code to <em>choose</em> to execute
  the request asynchronously or synchronously then we can use <code>call()</code>.
  This is similar to <em>Retrofit Call</em> for people who are familiar with that.
</p>
<p>
  The client can then choose to <em>execute()</em> the request synchronously or
  choose <em>async()</em> to execute the request asynchronously.
</p>
<p>
  Reference API javadoc <a href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/HttpCall.html">HttpCall</a>
</p>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpCall</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;&gt;</span> <span class="n">call</span> <span class="o">=</span>
  <span class="n">clientContext</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
    <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;customers&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">call</span><span class="o">().</span><span class="na">list</span><span class="o">(</span><span class="n">Customer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

<span class="c1">// Either execute synchronously</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">Customer</span><span class="o">&gt;</span> <span class="n">customers</span> <span class="o">=</span>  <span class="n">call</span><span class="o">.</span><span class="na">execute</span><span class="o">();</span>

<span class="c1">// Or execute asynchronously</span>
<span class="n">call</span><span class="o">.</span><span class="na">async</span><span class="o">()</span>
  <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">customers</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">});</span>
</pre></div>
</div>


<h2 id="auth">Authorisation</h2>
<p>
  <em>avaje-http-client</em> has built in support for <a href="#auth-basic">basic auth</a> and
  <a href="#auth-bearer">bearer token</a> based authorisation.
</p>

<h3 id="auth-basic">Basic Auth</h3>
<p>
  We can use <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/BasicAuthIntercept.html"><code>BasicAuthIntercept</code></a>
  to intercept all requests adding a <code>Authorization: Basic ...</code> header.
</p>

<h4>Example</h4>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClientContext</span> <span class="n">clientContext</span> <span class="o">=</span> <span class="n">HttpClientContext</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">withBaseUrl</span><span class="o">(</span><span class="n">baseUrl</span><span class="o">)</span>
  <span class="o">...</span>
  <span class="o">.</span><span class="na">withRequestIntercept</span><span class="o">(</span><span class="k">new</span> <span class="n">BasicAuthIntercept</span><span class="o">(</span><span class="s">&quot;myUsername&quot;</span><span class="o">,</span> <span class="s">&quot;myPassword&quot;</span><span class="o">))</span>  <span class="o">&lt;!--</span> <span class="n">HERE</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>


<h3 id="auth-bearer">Bearer token Authorization - AuthTokenProvider</h3>
<p>
  For Authorization using <em>Bearer</em> tokens that are obtained and expire, implement
  <a target="_blank" href="/apidocs/avaje-http-client/io.avaje.http.client/io/avaje/http/client/AuthTokenProvider.html"><code>AuthTokenProvider</code></a>
  and register that when building the HttpClientContext.
</p>

<h4>Step 1. Implement AuthTokenProvider</h4>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">class</span> <span class="nc">MyAuthTokenProvider</span> <span class="kd">implements</span> <span class="n">AuthTokenProvider</span> <span class="o">{</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">AuthToken</span> <span class="nf">obtainToken</span><span class="o">(</span><span class="n">HttpClientRequest</span> <span class="n">tokenRequest</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">AuthTokenResponse</span> <span class="n">res</span> <span class="o">=</span> <span class="n">tokenRequest</span>
      <span class="o">.</span><span class="na">url</span><span class="o">(</span><span class="s">&quot;https://foo/v2/token&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;content-type&quot;</span><span class="o">,</span> <span class="s">&quot;application/json&quot;</span><span class="o">)</span>
      <span class="o">.</span><span class="na">body</span><span class="o">(</span><span class="n">authRequestAsJson</span><span class="o">())</span>
      <span class="o">.</span><span class="na">POST</span><span class="o">()</span>
      <span class="o">.</span><span class="na">bean</span><span class="o">(</span><span class="n">AuthTokenResponse</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">Instant</span> <span class="n">validUntil</span> <span class="o">=</span> <span class="n">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">expires_in</span><span class="o">).</span><span class="na">minusSeconds</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">AuthToken</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="na">access_token</span><span class="o">,</span> <span class="n">validUntil</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>

<h4>Step 2. Register with HttpClientContext</h4>

<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpClientContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="n">HttpClientContext</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
  <span class="o">.</span><span class="na">withBaseUrl</span><span class="o">(</span><span class="s">&quot;https://foo&quot;</span><span class="o">)</span>
  <span class="o">...</span>
  <span class="o">.</span><span class="na">withAuthTokenProvider</span><span class="o">(</span><span class="k">new</span> <span class="n">MyAuthTokenProvider</span><span class="o">())</span> <span class="o">&lt;!--</span> <span class="n">HERE</span>
  <span class="o">.</span><span class="na">build</span><span class="o">();</span>
</pre></div>
</div>

<h4>Token obtained and set automatically</h4>
<p>
  All requests using the HttpClientContext will automatically get
  an <em>Authorization</em> header with <em>Bearer</em> token added. The token will be
  obtained for initial request and then renewed when the token has expired.
</p>



<h2 id="10k">10K requests - Loom vs Async</h2>
<p>
  The following is a very quick and rough comparison of running 10,000 requests
  using <em>Async</em> vs <em>Loom</em>.
</p>
<p>
  The intention is to test the thought that in a "future Loom world" the
  desire to use <code>async()</code> execution with HttpClient reduces.
</p>
<p>
  TLDR: Caveat, caveat, more caveats ... initial testing shows Loom to be just a
  touch faster (~10%) than async.
</p>
<p>
  To run my tests I use <a href="https://github.com/avaje/avaje-jex">Jex</a> as the server
  (Jetty based) and have it running using Loom. For whatever testing you do
  you will need a server that can handle a very large number of concurrent requests.
</p>
<p>
  The Loom blocking request (make 10K of these)
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span>  <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">();</span>
</pre></div>
</div>
<p>
  The equivalent async request (make 10K of these joining the CompletableFuture's).
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">()</span>
  <span class="o">.</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
  <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
  <span class="o">.</span><span class="na">async</span><span class="o">()</span>
  <span class="o">.</span><span class="na">asString</span><span class="o">()</span>
  <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
    <span class="o">...</span>
  <span class="o">});</span>
</pre></div>
</div>


<h3 id="10k-async">10K requests using Async and reactive streams</h3>
<p>
  Use <code>.async()</code> to execute the requests which internally is using JDK
  HttpClient's reactive streams. The <code>whenComplete()</code> callback is invoked
  when the response is ready. Collect all the resulting CompletableFuture
  and wait for them all to complete.
</p>
<p>
Outline:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// Collect all the CompletableFuture&#39;s</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">CompletableFuture</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>

<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10_000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
  <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
    <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
    <span class="o">.</span><span class="na">async</span><span class="o">().</span><span class="na">asString</span><span class="o">()</span>
    <span class="o">.</span><span class="na">whenComplete</span><span class="o">((</span><span class="n">hres</span><span class="o">,</span> <span class="n">throwable</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
        <span class="c1">// confirm 200 response etc</span>
        <span class="o">...</span>
    <span class="o">}));</span>
<span class="o">}</span>

<span class="c1">// wait for all requests to complete via join() ...</span>
<span class="n">CompletableFuture</span><span class="o">.</span><span class="na">allOf</span><span class="o">(</span><span class="n">futures</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="k">new</span> <span class="n">CompletableFuture</span><span class="o">[</span><span class="mi">0</span><span class="o">])).</span><span class="na">join</span><span class="o">();</span>
</pre></div>
</div>

<h3 id="10k-loom">10K requests using Loom</h3>
<p>
  With Loom Java 17 EA Release we can use <code>Executors.newVirtualThreadExecutor()</code>
  to return an ExecutorService that uses Loom Virtual Threads. These are backed
  by "Carrier threads" (via ForkedJoinPool).
</p>
<p>
Outline:
</p>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="c1">// use Loom&#39;s Executors.newVirtualThreadExecutor()</span>
<span class="k">try</span> <span class="o">(</span><span class="n">ExecutorService</span> <span class="n">executorService</span> <span class="o">=</span> <span class="n">Executors</span><span class="o">.</span><span class="na">newVirtualThreadExecutor</span><span class="o">())</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10_000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
        <span class="n">executorService</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span><span class="k">this</span><span class="o">::</span><span class="n">task</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="syntax java"><div class="highlight"><pre><span></span><span class="kd">private</span> <span class="kt">void</span> <span class="nf">task</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">HttpResponse</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">hres</span> <span class="o">=</span>
    <span class="n">httpClient</span><span class="o">.</span><span class="na">request</span><span class="o">().</span><span class="na">path</span><span class="o">(</span><span class="s">&quot;s200&quot;</span><span class="o">)</span>
     <span class="o">.</span><span class="na">GET</span><span class="o">()</span>
     <span class="o">.</span><span class="na">asString</span><span class="o">();</span>

  <span class="c1">// confirm 200 response etc</span>
  <span class="o">...</span>
<span class="o">}</span>
</pre></div>
</div>
<p>
Caveat: Proper performance benchmarks are really hard and take a lot of effort.
</p>
<p>
  Running some "rough/approx performance comparison tests" using <em>Loom</em>
  build <code>17 EA 2021-09-14 / (build 17-loom+7-342)</code> vs <em>Async</em> for my environment
  and 10K request scenarios has loom execution around 10% faster than async.
</p>
<p>
  It looks like Loom and Async run in pretty much the same time although it
  currently looks that Loom is just a touch faster (perhaps due to how it does
  park/unpark). More investigation required.
</p>
<p>
  Date: 2021-06 <br/>
  Build: <code>17 EA 2021-09-14 / (build 17-loom+7-342)</code>.
</p>
<pre>
  openjdk version "17-loom" 2021-09-14
  OpenJDK Runtime Environment (build 17-loom+7-342)
  OpenJDK 64-Bit Server VM (build 17-loom+7-342, mixed mode, sharing)
</pre>


  </article>
</div>

<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
<script src="/js/site.js"></script>
</body>
</html>
